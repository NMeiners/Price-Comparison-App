<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Local Price Finder</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
:root {
  --bg: #f8f9fa;
  --fg: #111;
  --accent: #0066cc;
}
body.dark {
  --bg: #121212;
  --fg: #f0f0f0;
  --accent: #3399ff;
}
body {
  margin: 0;
  background: var(--bg);
  color: var(--fg);
  font-family: system-ui, sans-serif;
  display: flex;
  flex-direction: column;
  height: 100vh;
}
header {
  padding: .5em;
  display: flex;
  gap: .5em;
  align-items: center;
  background: var(--accent);
  color: white;
}
header input {
  flex: 1;
  padding: .4em;
  border: none;
  border-radius: 4px;
}
header button {
  padding: .4em .8em;
  border: none;
  background: white;
  color: var(--accent);
  border-radius: 4px;
  cursor: pointer;
}
#map { flex: 1; }
#results {
  max-height: 40vh;
  overflow-y: auto;
  background: var(--bg);
  border-top: 1px solid #ccc;
  padding: .5em;
}
.result {
  border-bottom: 1px solid #ccc;
  padding: .3em 0;
}
.settings {
  position: fixed;
  right: 1em;
  top: 1em;
  background: var(--bg);
  border: 1px solid #ccc;
  padding: .5em;
  border-radius: 6px;
  display: none;
}
.settings label { display: block; margin-top: .3em; }
.toggle {
  position: absolute;
  right: 1em;
  top: .5em;
  background: white;
  color: var(--accent);
  border: none;
  border-radius: 4px;
  padding: .3em .6em;
  cursor: pointer;
}
</style>
</head>
<body>
<header>
  <input id="search" type="text" placeholder="Search for a product (e.g., milk, bread, tires)" />
  <button id="go">Search</button>
  <button class="toggle" id="settingsBtn">⚙</button>
</header>
<div id="map"></div>
<div id="results"></div>

<div class="settings" id="settingsMenu">
  <strong>Settings</strong>
  <label>Units:
    <select id="units">
      <option value="miles">Miles</option>
      <option value="km">Kilometers</option>
    </select>
  </label>
  <label>Search Radius (miles):
    <input type="number" id="radius" value="5" min="1" max="50" />
  </label>
  <label>
    <input type="checkbox" id="themeToggle"> Dark Mode
  </label>
  <button id="closeSettings">Close</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// --- helpers ---
const el = id => document.getElementById(id);
function deg2rad(d){return d*Math.PI/180;}
function distanceMiles(a,b){
  const R=3958.8;
  const dLat=deg2rad(b.lat-a.lat);
  const dLon=deg2rad(b.lon-a.lon);
  const aa=Math.sin(dLat/2)**2+Math.cos(deg2rad(a.lat))*Math.cos(deg2rad(b.lat))*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(aa),Math.sqrt(1-aa));
}
function distanceKm(a,b){return distanceMiles(a,b)*1.60934;}
function fuzzyIncludes(hay,needle){
  hay=hay.toLowerCase(); needle=needle.toLowerCase();
  return hay.includes(needle) || needle.split(/\s+/).some(w=>hay.includes(w));
}
function estimatePrice(item){
  const base={
    milk:3.79,bread:2.49,tires:120,coffee:9.99,eggs:4.49,
    cheese:6.5,apple:1.99,banana:0.79
  };
  let key=Object.keys(base).find(k=>fuzzyIncludes(item,k));
  if(!key) return (Math.random()*50+1).toFixed(2);
  const varFactor=1+((Math.random()-.5)/5);
  return (base[key]*varFactor).toFixed(2);
}

// --- map init ---
let map=L.map('map').setView([39.5,-98.35],4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let markers=[];

function clearMarkers(){
  markers.forEach(m=>m.remove());
  markers=[];
}

async function doSearch(){
  const term=el('search').value.trim();
  if(!term){alert("Enter a product name.");return;}
  el('results').innerHTML="Searching...";
  clearMarkers();
  // get location
  let pos;
  try{
    pos=await new Promise((res,rej)=>{
      navigator.geolocation.getCurrentPosition(p=>res(p.coords),rej,{timeout:8000});
    });
  }catch{ // fallback to map center
    pos={latitude:39.7392,longitude:-104.9903};
  }
  const radiusMiles=parseFloat(el('radius').value)||5;
  const radiusKm=radiusMiles*1.60934;
  const units=el('units').value;
  map.setView([pos.latitude,pos.longitude],12);

  // Overpass query for nearby stores
  const query=`[out:json][timeout:25];
  (
    node["shop"](around:${radiusKm*1000},${pos.latitude},${pos.longitude});
    node["amenity"="supermarket"](around:${radiusKm*1000},${pos.latitude},${pos.longitude});
    node["amenity"="convenience"](around:${radiusKm*1000},${pos.latitude},${pos.longitude});
  );out body;`;

  let data;
  try{
    const res=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:query});
    data=await res.json();
  }catch(e){
    el('results').innerHTML="Search failed.";
    console.error(e);
    return;
  }

  const user={lat:pos.latitude,lon:pos.longitude};
  const stores=data.elements.filter(n=>n.tags && (n.tags.name||n.tags.brand));

  // relevance filtering (exclude non-retail)
  const exclude=["auto","car","moto","repair","dealer","church","school","bank","atm"];
  const filtered=stores.filter(s=>{
    const n=(s.tags.name||"").toLowerCase()+" "+(s.tags.shop||"");
    return !exclude.some(x=>n.includes(x));
  });

  const results=filtered.map(s=>{
    const name=s.tags.name||s.tags.brand||"Unnamed";
    const shopType=s.tags.shop||s.tags.amenity||"store";
    const dist=units==="miles"?distanceMiles(user,{lat:s.lat,lon:s.lon}):distanceKm(user,{lat:s.lat,lon:s.lon});
    return {name,shopType,lat:s.lat,lon:s.lon,dist,price:estimatePrice(term)};
  }).sort((a,b)=>a.dist-b.dist);

  if(!results.length){el('results').innerHTML="No relevant stores found.";return;}

  const resDiv=el('results');
  resDiv.innerHTML="";
  results.forEach(r=>{
    const div=document.createElement("div");
    div.className="result";
    div.innerHTML=`<strong>${r.name}</strong><br>
    ${r.shopType} • ${r.dist.toFixed(1)} ${units}<br>
    ${term}: $${r.price}`;
    resDiv.appendChild(div);
    const m=L.marker([r.lat,r.lon]).addTo(map)
      .bindPopup(`<b>${r.name}</b><br>${term}: $${r.price}<br>${r.dist.toFixed(1)} ${units}`);
    markers.push(m);
  });
}

// --- event bindings ---
el('go').onclick=doSearch;
el('search').addEventListener("keydown",e=>{if(e.key==="Enter")doSearch();});

el('settingsBtn').onclick=()=>{el('settingsMenu').style.display="block";};
el('closeSettings').onclick=()=>{el('settingsMenu').style.display="none";};
el('themeToggle').onchange=e=>{
  document.body.classList.toggle("dark",e.target.checked);
};
</script>
</body>
</html>
